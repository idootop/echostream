# 设计优化

此阶段，是根据上一阶段给出的初步规划进一步优化一些细节。

目标是优化统一 API 设计和开发体验，确保模块划分和各层级的调用方法是一致的。

# 历史记录

> 下面的操作，主要通过和网页版的 gemini 3 flash 多轮对话润色完成

## 1. 统一 handler 命名风格

```markdown
当前处理器定义:

- `handler` 宏：请求处理器
- `listener` 宏：事件监听器
- `stream_handler` 宏：流处理器
  我觉得 handler 和 stream_handler 命名上有些不协调，针对 rpc，event 和 stream 这三种类型的处理器，请给出一些合适的命名

服务 builder 里的处理器注册方法名称用什么合适：
let server = EchoServer::builder()
.bind("0.0.0.0:5000")
.handler(handle_request)
.listener(handle_event)
```

| 宏名称      | Builder 方法名 (推荐) | 逻辑说明                                    |
| ----------- | --------------------- | ------------------------------------------- |
| `#[rpc]`    | `.add_rpc()`          | 双向、有状态的调用，强调 Request/Response。 |
| `#[event]`  | `.add_event()`        | 异步、广播式或单向的消息分发。              |
| `#[stream]` | `.add_stream()`       | 连续、高频率、有时间对齐要求的音频/数据流。 |

## 2. 优化 echostream-derive 模块

```markdown
优化 crates/echostream-derive/README.md，要求：
- 支持不指定方法名称，自动取函数名称
- 支持无参数请求
- 支持无 session
```

方案：
- **声明式 API**：隐藏 `Bytes` 处理细节，开发者仅需关注强类型业务函数。
- **零成本抽象**：使用影子结构体 (Shadow Structs) 实现零大小类型 (ZST)，无运行时性能损耗。
- **编译期验证**：通过过程宏在编译阶段拦截不符合 `Session` 或 `Codec` 要求的函数签名。
- `parser.rs`: 使用 `darling` 提取宏属性（如 `name`, `timeout`），使用 `syn` 解析函数签名（Args, Return）。
- `extractors.rs`: 根据函数参数自动匹配提取策略（Session-Only, Payload-Only, Full 等）。
- `codegen/`: 包含 `rpc`, `event`, `stream` 三大生成器，负责实现框架核心 Trait。