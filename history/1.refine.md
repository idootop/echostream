# 设计优化

此阶段，是根据上一阶段给出的初步规划进一步优化一些细节。

目标是优化统一 API 设计和开发体验，确保模块划分和各层级的调用方法是一致的。

# 历史记录

> 下面的操作，主要通过和网页版的 gemini 3 flash 多轮对话润色完成

## 1. 统一 handler 命名风格

```markdown
当前处理器定义:

- `handler` 宏：请求处理器
- `listener` 宏：事件监听器
- `stream_handler` 宏：流处理器
  我觉得 handler 和 stream_handler 命名上有些不协调，针对 rpc，event 和 stream 这三种类型的处理器，请给出一些合适的命名

服务 builder 里的处理器注册方法名称用什么合适：
let server = EchoServer::builder()
.bind("0.0.0.0:5000")
.handler(handle_request)
.listener(handle_event)
```

| 宏名称      | Builder 方法名 (推荐) | 逻辑说明                                    |
| ----------- | --------------------- | ------------------------------------------- |
| `#[rpc]`    | `.add_rpc()`          | 双向、有状态的调用，强调 Request/Response。 |
| `#[event]`  | `.add_event()`        | 异步、广播式或单向的消息分发。              |
| `#[stream]` | `.add_stream()`       | 连续、高频率、有时间对齐要求的音频/数据流。 |

## 2. 优化 echostream-derive 模块

```markdown
优化 crates/echostream-derive/README.md，要求：

- 支持不指定方法名称，自动取函数名称
- 支持无参数请求
- 支持无 session
```

方案：

- **声明式 API**：隐藏 `Bytes` 处理细节，开发者仅需关注强类型业务函数。
- **零成本抽象**：使用影子结构体 (Shadow Structs) 实现零大小类型 (ZST)，无运行时性能损耗。
- **编译期验证**：通过过程宏在编译阶段拦截不符合 `Session` 或 `Codec` 要求的函数签名。
- `parser.rs`: 使用 `darling` 提取宏属性（如 `name`, `timeout`），使用 `syn` 解析函数签名（Args, Return）。
- `extractors.rs`: 根据函数参数自动匹配提取策略（Session-Only, Payload-Only, Full 等）。
- `codegen/`: 包含 `rpc`, `event`, `stream` 三大生成器，负责实现框架核心 Trait。

## 2. 优化 echostream-discovery 模块

```markdown
优化下面的设计方案，要求保持精简，并给出核心 API 和使用场景示例，最后给出完整的 md 文件。

补充：
- 独立设计 echostream-discovery 子模块的功能即可
- 不要设计主模块的 EchoServer/EchoClient 的使用 API

// claude code
优化 crates/echostream-discovery/README.md 子模块的方案设计，结合下面的内容，保持精简：
```

## 3. 重新拆分模块依赖，方便第三方插件的开发

```markdown
请帮我重新设计整个框架，这是一个 rpc 系统，支持注册自定义插件和中间件，并且提供方便的 derive，请帮我重新设计模块划分。

注意只需要重新调整模块目录和 readme 模块设计文档，不需要实现 src 代码。

下面的思路仅供参考：

更新 crates/echostream-proto 和 crates/echostream-transport 模块的 readme 设计文档，
并将这两个模块更新到 crates/echostream/README.md
```

## 4. 创建插件和中间件目录，并定义核心插件/中间件

```markdown
帮我在合适的位置创建项目中的插件和中间件目录，并在子目录中创建 readme 设计规划核心的常用插件和中间件模块。
```

好的,我了解了项目结构。现在我会创建插件和中间件目录,并设计规划核心模块。根据项目的定位(轻量级RPC/流式通信框架),我会创建以下结构:
- echostream-middleware - 中间件模块
- echostream-plugin - 插件模块

```markdown
你搞错了，插件和中间件目录是存放核心插件集合模块和独立的第三方插件，就像 examples 那样，并不是一个独立子模块
```

## 5. 细化各个模块接口设计

```markdown
我这在设计一个 rust rpc+stream 传输系统，已经完成了初步的框架模块化设计，但是各个部分的细节尚不清晰。

现在的首要目标是完成各个模块的 API 设计，并且保证各个模块的 API 是一致的，避免出现冲突和不一致的情况发生。

所以你要综合分析 README.md 主项目的介绍和 crates 下各个模块的 README.md 介绍，

请你从全局的视角出发，细化明确各个子模块的分工和 API 设计。
```

好的,我已经全面了解了项目结构。现在让我创建一个详细的 API 设计分析文档。

```markdown
不要创建单独的 API 设计文档，请直接更新到对应模块的 readme 中。
```

只给出了合并后的 API—design 文件。