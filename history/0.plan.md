# 项目规划

这是整个项目的实施蓝图，定义了整个系统的技术架构和各个子模块的实现细节。

核心是定义清晰：

- 当前系统的主要功能列表
- 抽象出的各个层级和子模块职责
- 每个模块核心的 API 和使用代码示例

按照定义好的 API 接口设计，后续让 AI 倒推实现各个子模块，保持整体和局部实现的稳定。

# 历史记录

> 以下对话调整基于 claude code sonnet 4.5

## 1. 初始化项目 readme + architecture + roadmap

```markdown
## 任务

我正在做一个 rust 的 rpc 框架，它支持：

- client/server 异步双向通信，包含：
  - 信号控制（request、response、event）
  - 实时数据传输（stream，需要支持时间同步）
- 局域网零配置服务发现（可选能力，支持手动指定）

目标场景是用于 client 和 server 之间的实时通信，

方便开发者快速注册实现自定义的命令处理、事件监听和数据流的实时传输。

## 目标

现在请你设计一下整个系统的模块构成和技术栈，以及整体的开发版本规划。

- 完成项目的整体架构和技术栈设计，并更新到 docs/README.md
- 完成项目开发版本规划，并更新到 docs/ROADMAP.md
```

问题：

- 生成的文档太繁琐，尤其是 Roadmap，编辑不可控
- Roadmap 里的功能模块无法串行实现，会造成模块重写
- 后续 readme + architecture + roadmap 文件内容编辑同步比较困难

优化：

- 先要求生成 README 包含：
  - 项目主要功能亮点
  - 项目文件目录结构
  - 项目拆分后的模块列表
  - 给出每个子模块的：
    - 功能列表 + 依赖的技术栈
    - 核心 API + 示例代码
  - 主项目快速开始的核心 API + 示例代码
- 去掉 architecture 和 roadmap 规划文件
  - 将所有的蓝图指引放到 readme 下
  - 一个源，而非分散管理
  - 方便引导 AI 编辑修改局部内容

## 2. 将项目规划蓝图收敛到 readme 一个文件中，方便编辑修改

```markdown
请按照下面的格式重新整理 readme 和本项目的设计

- 项目标题 + slogan
- 项目一句话简介
- 项目亮点
- 项目架构
  - 目录结构（模块划分 + 职责）
  - 模块列表
    - 模块作用和职责简介
    - 子模块文件划分（一句话简介）
    - 依赖的外部 package 列表和作用
    - 核心 API 设计 + 精简示例代码
- 项目快速上手
  - client / server 示例
  - 核心概念与代码演示

补充信息：

- 项目使用 monorepo（基于 cargo workspace）
- 数据序列化/反序列化使用 postcard 替代 bincode（后者不再维护了
- 默认启用 client 局域网零配置发现 server，但也支持手动指定 server 地址连接（公网环境）
```

目录结构设计的不是很理想，需要再优化

## 3. 调整项目代码组织结构

```markdown
重新组织一下 docs/README.md 里设计的目录结构，packages 放到 crates/ 下面，示例放到 examples/ 还有 sdk/ 目录放未来 node-js 和 python 的绑定 sdk，注意是基于 cargo workspace 的 monorepo 结构！示例（仅供参考）：
echostream/
├── Cargo.toml # Workspace 定义
├── README.md
├── crates/
│ ├── echostream-core/ # 核心 Trait 定义、消息封包协议
│ ├── echostream-net/ # 网络层（QUIC/TCP 包装）
│ ├── echostream-sync/ # 音频同步、Jitter Buffer、时钟校准算法
│ ├── echostream-discovery/# mDNS/ETCD 服务发现
│ └── echostream-macros/ # 过程宏 (#[rpc_handler] 等)
├── examples/ # 实时音视频演示 demo
│ ├── simple_rpc.rs
│ └── audio_stream_sync.rs
└── sdk/ # (可选) 未来提供给其他语言的 C-FFI 或 WASM 绑定
```

## 4. 增加插件机制和生命周期 hook

```markdown
继续完善 docs/README.md 里的项目设计：

- 增加生命周期 hook：
  - 支持 client/server 初始化和销毁时机，用于初始化和回收资源等
  - 支持 session 连接/断开时机 hook，用于初始化和回收资源等
  - 可以在 hook 时机执行自定 async 逻辑
- 增加插件能力：
  - 可以修改 client/server 配置
  - 注册 rpc/event/stream handler 等
  - 可以 hook client/server 执行时机
```

继续完善

```markdown
现在 docs/README.md 里 Plugin 的接口定义不太理想，考虑：

- 拆分 client 和 server plugin
- plugin 里应该支持前面 client/server 定义的生命周期 hook 和注册方法
- 每个 plugin 不需要手动实现全部 trait 指定的方法，应该可选实现某个方法
- 或者更简单的 plugin 只需要处理 builder 的配置，手动拿到 builder 去更新调用自定义的方法注册

另外，在文档前面的目录结构和模块列表里加出来对应的模块和说明。

最后请搞清楚 client 和 server handler 的 ctx 类型是否一致？
server 要支持多 client 连接多 session 会话，消息收发应该是基于 session 的。
```

问题：

- 一些子模块的细节设计编辑起来不是很方便

优化：

- 需要拆分到子模块对应的 readme 下进行细化更新
- 将子模块细节和主项目 readme 解耦，隔离上下文

## 5. 创建 Monorepo 基础框架，方便细化子模块设计

```markdown
请按照 docs/README.md 中的功能设计，创建出 monorepo 各个子包。

注意：

- 只需要创建出来对应的文件夹和配置好对应的 Cargo.toml + workspace 的 Cargo.toml
- 不要创建 src 去实现子包和主包（后面会专门实现）

然后并将 docs/README.md 中各个子模块的设计移动到对应的子模块下的 README.md 中：

- 模块职责功能简介
- 功能列表 + 依赖的技术栈
- 核心 API + 示例代码

最后 docs/README.md 只保留主项目的文档信息即可。
```

## TODO

- 把 stream 能力拆分成独立的模块？
